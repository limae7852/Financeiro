<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoneyMagnet | Gestão Financeira</title>

  <!-- TailwindCSS + Feather Icons + Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
    .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .ativo { background-color: #2563eb !important; color: white !important; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
    <i data-feather="bar-chart-2"></i> MoneyMagnet | Gestão Financeira
  </h1>

  <!-- Formulário -->
  <div class="card mb-6">
    <form id="formTransacao" class="grid grid-cols-1 md:grid-cols-6 gap-4">
      <input type="text" id="descricao" placeholder="Descrição" class="border p-2 rounded" required>
      <input type="text" id="valor" placeholder="Valor (R$)" class="border p-2 rounded" required>
      <select id="tipo" class="border p-2 rounded" required>
        <option value="">Tipo</option>
        <option value="receita">Receita</option>
        <option value="despesa">Despesa</option>
      </select>
      <select id="formaPagamento" class="border p-2 rounded" required>
        <option value="">Forma de Pagamento</option>
        <option value="Pix">Pix</option>
        <option value="Cartão">Cartão</option>
        <option value="Boleto">Boleto</option>
        <option value="Dinheiro">Dinheiro</option>
        <option value="Transferência">Transferência</option>
      </select>
      <input type="date" id="dataMovimento" class="border p-2 rounded" disabled>
      <input type="date" id="dataVencimento" class="border p-2 rounded" disabled>
      <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 col-span-full md:col-span-1">Salvar</button>
    </form>
  </div>

  <!-- Filtros -->
  <div class="flex gap-2 mb-4">
    <button id="filtroTodas" class="border px-4 py-2 rounded bg-gray-100 hover:bg-gray-200 ativo">Todas</button>
    <button id="filtroAbertas" class="border px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Em Aberto</button>
    <button id="filtroPagas" class="border px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Pagas</button>
  </div>

  <!-- Resumo -->
  <div class="grid md:grid-cols-3 gap-4 mb-6">
    <div class="card text-center">
      <h2 id="totalReceitas" class="text-lg font-semibold text-green-700">Receitas: R$ 0,00</h2>
    </div>
    <div class="card text-center">
      <h2 id="totalDespesas" class="text-lg font-semibold text-red-700">Despesas: R$ 0,00</h2>
    </div>
    <div class="card text-center">
      <h2 id="saldoFinal" class="text-lg font-semibold text-blue-700">Saldo: R$ 0,00</h2>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="card mb-6">
    <canvas id="grafico" style="max-height: 260px;"></canvas>
  </div>

  <!-- Tabelas -->
  <div class="grid md:grid-cols-2 gap-6">
    <div class="card">
      <h3 class="text-xl font-bold mb-3 text-green-700">Receitas</h3>
      <table id="tabelaReceitas" class="w-full text-sm">
        <thead class="bg-green-100">
          <tr>
            <th class="p-2">Descrição</th>
            <th class="p-2">Valor</th>
            <th class="p-2">Forma</th>
            <th class="p-2">Data</th>
            <th class="p-2">Inclusão</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3 class="text-xl font-bold mb-3 text-red-700">Despesas</h3>
      <table id="tabelaDespesas" class="w-full text-sm">
        <thead class="bg-red-100">
          <tr>
            <th class="p-2">Descrição</th>
            <th class="p-2">Valor</th>
            <th class="p-2">Forma</th>
            <th class="p-2">Vencimento</th>
            <th class="p-2">Status</th>
            <th class="p-2">Baixa</th>
            <th class="p-2">Ação</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBKL1wKzXRmQl75S1L0JwEzsT_UPtoLq5o",
      authDomain: "moneymagnet-financeiro.firebaseapp.com",
      projectId: "moneymagnet-financeiro",
      storageBucket: "moneymagnet-financeiro.firebasestorage.app",
      messagingSenderId: "861048650591",
      appId: "1:861048650591:web:7d62142069a213b67b14ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById("formTransacao");
    const tipoSelect = document.getElementById("tipo");
    const formaPagamentoSelect = document.getElementById("formaPagamento");
    const dataMov = document.getElementById("dataMovimento");
    const dataVenc = document.getElementById("dataVencimento");
    const valorInput = document.getElementById("valor");
    const graficoCanvas = document.getElementById("grafico");
    const tabelaReceitas = document.getElementById("tabelaReceitas").querySelector("tbody");
    const tabelaDespesas = document.getElementById("tabelaDespesas").querySelector("tbody");

    let grafico;
    let filtroStatus = "todas";
    let cacheSnapshot = [];

    valorInput.addEventListener("input", () => {
      let v = valorInput.value.replace(/\D/g, "");
      v = (v / 100).toFixed(2) + "";
      v = v.replace(".", ",");
      v = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      valorInput.value = v;
    });

    function toBrDate(dateStr) {
      if (!dateStr) return "";
      const [yyyy, mm, dd] = dateStr.split("-");
      return `${dd}/${mm}/${yyyy}`;
    }
    function hojeBr() {
      const d = new Date();
      return `${String(d.getDate()).padStart(2, "0")}/${String(d.getMonth()+1).padStart(2, "0")}/${d.getFullYear()}`;
    }

    tipoSelect.addEventListener("change", () => {
      const tipo = tipoSelect.value;
      const hoje = new Date().toISOString().split("T")[0];
      if (tipo === "receita") {
        dataMov.disabled = false; dataMov.value = hoje;
        dataVenc.disabled = true; dataVenc.value = "";
      } else if (tipo === "despesa") {
        dataVenc.disabled = false; dataVenc.value = hoje;
        dataMov.disabled = true; dataMov.value = "";
      } else {
        dataMov.disabled = true; dataVenc.disabled = true;
        dataMov.value = ""; dataVenc.value = "";
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const descricao = document.getElementById("descricao").value.trim();
      const valor = parseFloat(valorInput.value.replace(/\./g, "").replace(",", "."));
      const tipo = tipoSelect.value;
      const formaPagamento = formaPagamentoSelect.value;
      const dataMovimento = dataMov.value ? toBrDate(dataMov.value) : "";
      const dataVencimento = dataVenc.value ? toBrDate(dataVenc.value) : "";

      if (!descricao || isNaN(valor) || !tipo || !formaPagamento) {
        alert("Preencha todos os campos corretamente!");
        return;
      }

      await addDoc(collection(db, "transacoes"), {
        descricao, valor, tipo, formaPagamento,
        dataMovimento, dataVencimento,
        pago: false, dataPagamento: "", dataInclusao: serverTimestamp()
      });

      form.reset(); dataMov.disabled = true; dataVenc.disabled = true;
    });

    function atualizarInterface(snapshotDocs) {
      tabelaReceitas.innerHTML = "";
      tabelaDespesas.innerHTML = "";
      let receitas = 0, despesas = 0;

      snapshotDocs.forEach(docSnap => {
        const t = docSnap.data();
        const id = docSnap.id;
        const valorFmt = t.valor ? t.valor.toFixed(2).replace(".", ",") : "0,00";

        if (t.tipo === "receita") {
          receitas += t.valor || 0;
          tabelaReceitas.innerHTML += `
            <tr class="border-b hover:bg-gray-50">
              <td class="p-2">${t.descricao}</td>
              <td class="p-2">R$ ${valorFmt}</td>
              <td class="p-2">${t.formaPagamento || "-"}</td>
              <td class="p-2">${t.dataMovimento || "-"}</td>
              <td class="p-2">${t.dataInclusao ? new Date(t.dataInclusao.seconds * 1000).toLocaleDateString("pt-BR") : "-"}</td>
            </tr>`;
        } else if (t.tipo === "despesa") {
          despesas += t.valor || 0;

          if (
            filtroStatus === "todas" ||
            (filtroStatus === "abertas" && !t.pago) ||
            (filtroStatus === "pagas" && t.pago)
          ) {
            tabelaDespesas.innerHTML += `
              <tr class="border-b hover:bg-gray-50">
                <td class="p-2">${t.descricao}</td>
                <td class="p-2">R$ ${valorFmt}</td>
                <td class="p-2">${t.formaPagamento || "-"}</td>
                <td class="p-2">${t.dataVencimento || "-"}</td>
                <td class="p-2 text-center">${t.pago ? "✅ Pago" : "⏳ Em aberto"}</td>
                <td class="p-2 text-gray-600">${t.dataPagamento || "-"}</td>
                <td class="p-2 text-center">
                  ${!t.pago ? `<button data-id="${id}" class="baixar bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Baixar</button>` : ""}
                </td>
              </tr>`;
          }
        }
      });

      document.getElementById("totalReceitas").innerText = `Receitas: R$ ${receitas.toFixed(2).replace(".", ",")}`;
      document.getElementById("totalDespesas").innerText = `Despesas: R$ ${despesas.toFixed(2).replace(".", ",")}`;
      document.getElementById("saldoFinal").innerText = `Saldo: R$ ${(receitas - despesas).toFixed(2).replace(".", ",")}`;

      atualizarGrafico(receitas, despesas);
      adicionarEventosBaixa();
    }

    function atualizarGrafico(receitas, despesas) {
      if (grafico) grafico.destroy();
      grafico = new Chart(graficoCanvas, {
        type: "doughnut",
        data: { labels: ["Receitas", "Despesas"], datasets: [{ data: [receitas, despesas], backgroundColor: ["#16a34a", "#dc2626"] }] },
        options: { plugins: { legend: { position: "bottom" } } }
      });
    }

    function adicionarEventosBaixa() {
      document.querySelectorAll(".baixar").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Deseja marcar esta despesa como paga?")) return;
          await updateDoc(doc(db, "transacoes", id), {
            pago: true, dataPagamento: hojeBr()
          });
        });
      });
    }

    function ativarBotao(botaoId) {
      document.querySelectorAll(".ativo").forEach(b => b.classList.remove("ativo"));
      document.getElementById(botaoId).classList.add("ativo");
    }

    document.getElementById("filtroTodas").onclick = () => {
      filtroStatus = "todas"; ativarBotao("filtroTodas");
      atualizarInterface(cacheSnapshot);
    };
    document.getElementById("filtroAbertas").onclick = () => {
      filtroStatus = "abertas"; ativarBotao("filtroAbertas");
      atualizarInterface(cacheSnapshot);
    };
    document.getElementById("filtroPagas").onclick = () => {
      filtroStatus = "pagas"; ativarBotao("filtroPagas");
      atualizarInterface(cacheSnapshot);
    };

    onSnapshot(collection(db, "transacoes"), (snapshot) => {
      cacheSnapshot = snapshot.docs;
      atualizarInterface(cacheSnapshot);
    });

    feather.replace();
  </script>
</body>
</html>
