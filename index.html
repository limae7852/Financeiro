<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROSSETTI - Controle Financeiro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

  <div class="container py-4">
    <h2 class="text-center mb-4">üí∞ MoneyMagnet - Controle Financeiro</h2>

    <!-- FORMUL√ÅRIO DE TRANSA√á√ÉO -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Nova Transa√ß√£o</h5>
        <form id="formTransacao" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Descri√ß√£o</label>
            <input type="text" id="descricao" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Valor (R$)</label>
            <input type="number" id="valor" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Tipo</label>
            <select id="tipo" class="form-select" required>
              <option value="">Selecione</option>
              <option value="receita">Receita</option>
              <option value="despesa">Despesa</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- TABELA DE TRANSA√á√ïES -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Transa√ß√µes Registradas</h5>
        <table class="table table-striped" id="tabelaTransacoes">
          <thead>
            <tr>
              <th>Descri√ß√£o</th>
              <th>Tipo</th>
              <th>Valor (R$)</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RELAT√ìRIO -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">üìä Relat√≥rio de Receitas e Despesas</h5>
        <canvas id="grafico"></canvas>
        <div class="mt-4 text-center">
          <h5><span id="totalReceitas" class="text-success fw-bold"></span></h5>
          <h5><span id="totalDespesas" class="text-danger fw-bold"></span></h5>
          <h5><span id="saldoFinal" class="fw-bold"></span></h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBKL1wKzXRmQl75S1L0JwEzsT_UPtoLq5o",
      authDomain: "moneymagnet-financeiro.firebaseapp.com",
      projectId: "moneymagnet-financeiro",
      storageBucket: "moneymagnet-financeiro.firebasestorage.app",
      messagingSenderId: "861048650591",
      appId: "1:861048650591:web:7d62142069a213b67b14ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById('formTransacao');
    const tabela = document.getElementById('tabelaTransacoes').querySelector('tbody');
    const graficoCanvas = document.getElementById('grafico');

    let grafico;

    // Salvar transa√ß√£o
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const descricao = document.getElementById('descricao').value;
      const valor = parseFloat(document.getElementById('valor').value);
      const tipo = document.getElementById('tipo').value;

      if (!descricao || !valor || !tipo) return alert("Preencha todos os campos!");

      await addDoc(collection(db, "transacoes"), {
        descricao,
        valor,
        tipo,
        data: serverTimestamp()
      });

      form.reset();
    });

    // Atualizar tabela e relat√≥rio em tempo real
    onSnapshot(collection(db, "transacoes"), (snapshot) => {
      tabela.innerHTML = "";
      let receitas = 0;
      let despesas = 0;

      snapshot.forEach(doc => {
        const t = doc.data();
        const dataFormatada = t.data ? new Date(t.data.toDate()).toLocaleString() : "-";

        const linha = `
          <tr>
            <td>${t.descricao}</td>
            <td class="${t.tipo === 'receita' ? 'text-success' : 'text-danger'}">${t.tipo}</td>
            <td>${t.valor.toFixed(2)}</td>
            <td>${dataFormatada}</td>
          </tr>
        `;
        tabela.innerHTML += linha;

        if (t.tipo === "receita") receitas += t.valor;
        else despesas += t.valor;
      });

      // Atualizar totais
      document.getElementById("totalReceitas").innerText = `Receitas: R$ ${receitas.toFixed(2)}`;
      document.getElementById("totalDespesas").innerText = `Despesas: R$ ${despesas.toFixed(2)}`;
      document.getElementById("saldoFinal").innerText = `Saldo: R$ ${(receitas - despesas).toFixed(2)}`;

      // Atualizar gr√°fico
      atualizarGrafico(receitas, despesas);
    });

    // Fun√ß√£o do gr√°fico
    function atualizarGrafico(receitas, despesas) {
      if (grafico) grafico.destroy();
      grafico = new Chart(graficoCanvas, {
        type: 'doughnut',
        data: {
          labels: ['Receitas', 'Despesas'],
          datasets: [{
            data: [receitas, despesas],
            backgroundColor: ['#198754', '#dc3545']
          }]
        }
      });
    }
  </script>
</body>
</html>
