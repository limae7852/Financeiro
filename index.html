<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoneyMagnet | Gest√£o Financeira</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50 min-h-screen">
  <!-- Navbar -->
  <nav class="bg-indigo-700 text-white p-4 shadow">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">üí∞ MoneyMagnet</h1>
      <a href="#" class="hover:underline">Dashboard</a>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
      <div>
        <h2 class="text-3xl font-bold text-gray-800">Painel Financeiro</h2>
        <p class="text-gray-600">Controle completo de receitas e despesas</p>
      </div>
    </div>

    <!-- Formul√°rio -->
    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Nova Transa√ß√£o</h3>
      <form id="formTransacao" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
        <input type="text" id="descricao" placeholder="Descri√ß√£o" class="border p-2 rounded col-span-1 md:col-span-2" />
        <input type="text" id="valor" placeholder="Valor (R$)" class="border p-2 rounded" inputmode="decimal" />
        
        <select id="tipo" class="border p-2 rounded">
          <option value="">Tipo</option>
          <option value="receita">Receita</option>
          <option value="despesa">Despesa</option>
        </select>

        <input type="date" id="dataMovimento" class="border p-2 rounded hidden" />
        <input type="date" id="vencimento" class="border p-2 rounded hidden" />

        <!-- Checkbox Despesa Paga -->
        <div id="campoPago" class="flex items-center gap-2 hidden">
          <input type="checkbox" id="pago" class="w-4 h-4">
          <label for="pago" class="text-sm text-gray-700">Despesa Paga?</label>
        </div>

        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
          <i data-feather="plus" class="inline w-4 h-4 mr-1"></i>Salvar
        </button>
      </form>
    </div>

    <!-- Totais -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div id="totalReceitas" class="bg-green-100 text-green-700 p-4 rounded-xl text-center font-semibold">Receitas: R$ 0,00</div>
      <div id="totalDespesas" class="bg-red-100 text-red-700 p-4 rounded-xl text-center font-semibold">Despesas: R$ 0,00</div>
      <div id="saldoFinal" class="bg-blue-100 text-blue-700 p-4 rounded-xl text-center font-semibold">Saldo: R$ 0,00</div>
    </div>

    <!-- Gr√°fico -->
    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Relat√≥rio de Receitas e Despesas</h3>
      <canvas id="grafico" height="30" style="max-width:300px; margin:auto;"></canvas>
    </div>

    <!-- Tabela -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Transa√ß√µes</h3>
      <div class="overflow-x-auto">
        <table id="tabelaTransacoes" class="w-full text-left border">
          <thead>
            <tr class="bg-gray-200 text-gray-700">
              <th class="p-2">Descri√ß√£o</th>
              <th class="p-2">Tipo</th>
              <th class="p-2">Valor (R$)</th>
              <th class="p-2">Data Movimento</th>
              <th class="p-2">Data Vencimento</th>
              <th class="p-2">Pago?</th>
              <th class="p-2">Data Inclus√£o</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, onSnapshot,
      serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBKL1wKzXRmQl75S1L0JwEzsT_UPtoLq5o",
      authDomain: "moneymagnet-financeiro.firebaseapp.com",
      projectId: "moneymagnet-financeiro",
      storageBucket: "moneymagnet-financeiro.firebasestorage.app",
      messagingSenderId: "861048650591",
      appId: "1:861048650591:web:7d62142069a213b67b14ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById("formTransacao");
    const tabela = document.querySelector("#tabelaTransacoes tbody");
    const inputValor = document.getElementById("valor");
    const inputTipo = document.getElementById("tipo");
    const inputVencimento = document.getElementById("vencimento");
    const inputMovimento = document.getElementById("dataMovimento");
    const campoPago = document.getElementById("campoPago");
    const checkPago = document.getElementById("pago");
    let grafico;

    // Alterna entre campos conforme o tipo
    inputTipo.addEventListener("change", () => {
      if (inputTipo.value === "receita") {
        inputMovimento.classList.remove("hidden");
        inputVencimento.classList.add("hidden");
        campoPago.classList.add("hidden");
        inputMovimento.disabled = false;
        inputVencimento.disabled = true;
        campoPago.disabled = true;
      } else if (inputTipo.value === "despesa") {
        inputVencimento.classList.remove("hidden");
        campoPago.classList.remove("hidden");
        inputMovimento.classList.add("hidden");
        inputMovimento.disabled = true;
        inputVencimento.disabled = false;
        campoPago.disabled = false;
        inputVencimento.classList.add("border-red-500", "bg-red-50");
      } else {
        inputMovimento.classList.add("hidden");
        inputVencimento.classList.add("hidden");
        campoPago.classList.add("hidden");
      }
    });

    // M√°scara de valor em tempo real
    inputValor.addEventListener("input", () => {
      let valor = inputValor.value.replace(/\D/g, "");
      valor = (parseInt(valor, 10) / 100).toFixed(2) + "";
      valor = valor.replace(".", ",");
      valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      inputValor.value = valor;
    });

    // Enviar dados
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const descricao = document.getElementById("descricao").value.trim();
      const valorTexto = inputValor.value.replace(/\./g, "").replace(",", ".");
      const valor = parseFloat(valorTexto);
      const tipo = inputTipo.value;
      const vencimento = inputVencimento.value;
      const dataMovimento = inputMovimento.value;
      const pago = checkPago.checked;

      if (!descricao || isNaN(valor) || !tipo) {
        alert("Preencha todos os campos corretamente!");
        return;
      }

      await addDoc(collection(db, "transacoes"), {
        descricao,
        valor,
        tipo,
        vencimento: vencimento || null,
        dataMovimento: dataMovimento || null,
        pago,
        data: serverTimestamp()
      });

      form.reset();
      inputMovimento.classList.add("hidden");
      inputVencimento.classList.add("hidden");
      campoPago.classList.add("hidden");
    });

    // Renderiza√ß√£o
    function carregarTransacoes(snapshot) {
      tabela.innerHTML = "";
      let receitas = 0, despesas = 0;

      snapshot.forEach(doc => {
        const t = doc.data();
        let dataInclusao = "-";
        if (t.data?.toDate) {
          const d = new Date(t.data.toDate());
          dataInclusao = d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        }

        const linha = `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2">${t.descricao}</td>
            <td class="p-2 ${t.tipo === 'receita' ? 'text-green-600' : 'text-red-600'}">${t.tipo}</td>
            <td class="p-2">${t.valor?.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
            <td class="p-2">${t.dataMovimento ? new Date(t.dataMovimento).toLocaleDateString('pt-BR') : '‚Äî'}</td>
            <td class="p-2">${t.vencimento ? new Date(t.vencimento).toLocaleDateString('pt-BR') : '‚Äî'}</td>
            <td class="p-2">${t.tipo === 'despesa' ? (t.pago ? '‚úÖ Pago' : '‚ùå Em aberto') : '‚Äî'}</td>
            <td class="p-2">${dataInclusao}</td>
          </tr>`;
        tabela.innerHTML += linha;

        if (t.tipo === "receita") receitas += t.valor;
        if (t.tipo === "despesa") despesas += t.valor;
      });

      document.getElementById("totalReceitas").innerText = `Receitas: R$ ${receitas.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
      document.getElementById("totalDespesas").innerText = `Despesas: R$ ${despesas.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
      document.getElementById("saldoFinal").innerText = `Saldo: R$ ${(receitas - despesas).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;

      atualizarGrafico(receitas, despesas);
    }

    // Gr√°fico
    function atualizarGrafico(receitas, despesas) {
      if (grafico) grafico.destroy();
      grafico = new Chart(document.getElementById("grafico"), {
        type: "doughnut",
        data: {
          labels: ["Receitas", "Despesas"],
          datasets: [{
            data: [receitas, despesas],
            backgroundColor: ["#16a34a", "#dc2626"]
          }]
        },
        options: { plugins: { legend: { position: "bottom" } } }
      });
    }

    const q = query(collection(db, "transacoes"), orderBy("data", "desc"));
    onSnapshot(q, (snap) => carregarTransacoes(snap));
    getDocs(collection(db, "transacoes")).then((snap) => carregarTransacoes(snap));
    feather.replace();
  </script>
</body>
</html>
